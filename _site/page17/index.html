
<!DOCTYPE html>
<html language="en"><head>
  <meta charset="utf-8">
  <title>naildrivin5.com - David Bryant Copeland's Website</title>
  <meta name="author" content="David Bryant Copeland">
  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/favicons/ms-icon-144x144.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  

  
  <meta name="description" content="
  
  
  
    
      
        
        Getting Rake's PackageTask to depend on generated files
        
        September 17, 2008
      
      
  ...">
  

  
  <link rel="canonical" href="http://naildrivin5.com/page17/">
  <link href="/favicon.png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="naildrivin5.com - David Bryant Copeland's Website" type="application/atom+xml">
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://use.typekit.net/ylm4zpa.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>
            
  <meta name="google-site-verification" content="h_yTpXa6N3ebHj8DYmgX4lIFGHBW1NtGMVHfXuu7i_4" />
</head>
<body>
  <header class="site-header pb2 mb2 center">
    <h1 class="uc ls2 f1"><a href="/">naildrivin5.com</a></h1>
    <h2 class="ls1"><small class="uc h4">Website of</small> David Bryant Copeland</h2>
    <nav>
      <ul>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/">Blog</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/bio">About</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/books">Books</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/talks">Talks</a></li>
      </ul>
      <div style="clear: both"></div>
    </nav>
  </header>
  <main>
    <section>
      <div class="blog-index">
  
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2008/09/17/getting-rakes-packagetask-to-depend-on-generated-files.html">Getting Rake's PackageTask to depend on generated files</a></h1>
        
        <h2 class="f6 mtneg">September 17, 2008</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            Been playing with <a href="http://rake.rubyforge.org/">Rake</a> lately and decided to use it to package up the PHP Client Library for the <a href="http://www.gliffy.com">Gliffy</a> <a href="http://jira.gliffy.com/browse/GLIFFY-775">integration API</a>.  Didn't seem to make sense to use ant for something that amounts to creating a tarball.  <tt>make</tt> would be appropriate here, too, but I figured it would be cool to use Rake and there's not really much harm in doing so.

A large annoyance is <tt>Rake::PackageTask</tt>.  This is a seemingly handy task that creates tars, zips, etc. and is pretty useful.  It's not a task in and of itself, but it creates the <tt>:package</tt> task:

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Rake</span><span class="o">::</span><span class="no">PackageTask</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"gliffy-php-client"</span><span class="p">,</span><span class="no">GLIFFY_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
    <span class="nb">p</span><span class="p">.</span><span class="nf">need_tar</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="nb">p</span><span class="p">.</span><span class="nf">need_zip</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="nb">p</span><span class="p">.</span><span class="nf">package_files</span> <span class="o">=</span> <span class="no">SRC_FILES</span> <span class="o">+</span> <span class="no">EXAMPLE_FILES</span> <span class="o">+</span> <span class="no">DOC_FILES</span>
<span class="k">end</span></code></pre></figure>

Unfortunately, this doesn't do what it seems to do.  <tt>DOC_FILES</tt> is the list of documentation files output by <a href="http://www.phpdoc.org/">phpDocumentor</a> and are not checked into version control.  The syntax of the <tt>PackageTask</tt> makes it appear that the code in the block will run when the <tt>:package</tt> task executes, however this is not the case.  This code is initialization code.  So, I tried:
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># DOC_DIR is the dir generated by phpdoc, a task elsewhere</span>
<span class="c1"># uses this to kick off phpdoc</span>
<span class="n">task</span> <span class="ss">:package</span> <span class="o">=&gt;</span> <span class="no">DOC_DIR</span></code></pre></figure>

The result is that the tarball and zip files are created and <b>then</b> the documentation is generated.  The reason is that <tt>PackageTask.new</tt> creates a set of tasks and the actual creation of the tarball/zip file is done via a <tt>file</tt> task, upon which <tt>:package</tt> is dependent.  So, the real dependency I created was:
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">task</span> <span class="ss">:package</span> <span class="o">=&gt;</span> <span class="s2">"gliffy-php-client.zip"</span> <span class="s2">"gliffy-php-client.tgz"</span> <span class="no">DOC_DIR</span></code></pre></figure>

Examining the source code, a task named for the directory created by <tt>:package</tt> is created.  This task is dependent on the <tt>package_files</tt> set up in the constructor.  So <b>this</b> is the task I need to use:
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Have to keep a reference to the PackageTask object</span>
<span class="n">package_task</span> <span class="o">=</span> <span class="no">Rake</span><span class="o">::</span><span class="no">PackageTask</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"gliffy-php-client"</span><span class="p">,</span><span class="no">GLIFFY_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
    <span class="nb">p</span><span class="p">.</span><span class="nf">need_tar</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="nb">p</span><span class="p">.</span><span class="nf">need_zip</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="c1"># Executed BEFORE any other tasks; DOC_FILES don't exist  yet</span>
    <span class="nb">p</span><span class="p">.</span><span class="nf">package_files</span> <span class="o">=</span> <span class="no">SRC_FILES</span> <span class="o">+</span> <span class="no">EXAMPLE_FILES</span>
<span class="k">end</span>

<span class="n">file</span> <span class="n">package_task</span><span class="p">.</span><span class="nf">package_dir_path</span> <span class="o">=&gt;</span> <span class="no">DOC_DIR</span>

<span class="n">file</span> <span class="no">DOC_DIR</span> <span class="o">=&gt;</span> <span class="no">SRC_FILES</span> <span class="o">+</span> <span class="no">EXAMPLE_FILES</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="nb">system</span><span class="p">(</span><span class="s2">"phpdoc </span><span class="si">#{</span><span class="no">PHP_DOC_ARGS</span><span class="si">}</span><span class="s2">"</span><span class="p">);</span>
    <span class="n">doc_files</span> <span class="o">=</span> <span class="no">FileList</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">DOC_DIR</span> <span class="o">+</span> <span class="s2">"/**/**"</span><span class="p">);</span>
    <span class="c1"># Have to add these files to the package_task file list</span>
    <span class="n">package_task</span><span class="p">.</span><span class="nf">package_files</span> <span class="o">=</span> <span class="n">package_task</span><span class="p">.</span><span class="nf">package_files</span> <span class="o">+</span> <span class="n">doc_files</span>
<span class="k">end</span></code></pre></figure>

This is definitely a hack, because I'm depending on the internal implementation of the <tt>PackageTask</tt>.  It really needs a facility for including generated files.  In <tt>make</tt>, I could just send the directory <tt>DOC_DIR</tt> to <tt>tar</tt> and it would pick up everything.  In Ant, I'd probably have to spawn another ant, since ant sets all property vaules at startup time.

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2008/09/17/better-open-source-hosting-sourceforge-is-looking-weak.html">Better open-source hosting: SourceForge is looking weak</a></h1>
        
        <h2 class="f6 mtneg">September 17, 2008</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            <p>I currently host <a href="http://vimdoclet.sf.net">my Vim Javadoc doclet</a> on <a href="http://www.sourceforge.net">SourceForge</a> and <b>every</b> time I have to deal with it, it's just a monumental pain.  The documentation is insanely long and detailed, the website looks horribly out of date and cruddy, and when compared to stuff like <a href="http://www.github.com">GitHub</a> and <a href="http://www.lighthouseapp.com">Lighthouse</a>, it's almost embarrassing how difficult it is to deal with and how bad the UI is (despite my best efforts, it <b>still</b> insists that the featured download is the vimdoc samples and not the doclet itself.  WTF?).
</p>
<p>
I'm already hosting the code in GitHub and just moved my tickets to Lighthouse.  The only thing left is where to host binary downloads and static assets.  For <a href="http://www.googlecode.com/p/restunit">RESTUnit</a>, I'm using <a href="http://code.google.com">Google Code</a>, which is pretty easy to deal with (about a zillion times simpler and easier than SourceForge), however it has no facility for hosting arbitrary HTML.  Currently, I'm just using my website for static assets.
</p>
<p>
While I do like the new Web-2.0 way of doing things (one site like GitHub really focusing on source, another like Lighthouse just does ticketing, etc. and they integrate via web services), I'm not sure where the best place is to host downloads and static assets.  I would need programmatic access and some liberal download/diskspace quotas for sure.  It would also be nice to be able to connect to other services, for example generate a changelog based on commits or tickets closed since the last release.
</p>

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2008/09/12/test-rest-services.html">Test REST Services</a></h1>
        
        <h2 class="f6 mtneg">September 12, 2008</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            <p>In my reply to <a href="http://www.tbray.org/ongoing/When/200x/2008/09/10/Misusing-RSpec">a post on Tim Bray's blog</a> about using RSpec for testing REST services, I briefly described a project I'm working on, based on the work I've been doing at <a href="http://www.gliffy.com">Gliffy</a>, which is a testing framework for REST services called, unsurprisingly, <a href="http://code.google.com/p/restunit/">RestUNIT</a>.
</p>
<p>
For Gliffy's REST-based <a href="http://jira.gliffy.com/browse/GLIFFY-775">integration API</a>, I needed a way to test it, and hand-coding test cases using <a href="http://hc.apache.org/httpclient-3.x/">HTTPClient</a> was just not going to cut it.  Further, requests to Gliffy's API require signing (similar to how Flickr does it), and our API was going to support multiple ways of specifying the representation type as well as tunneling over POST.
</p>
<p>
So, it occured to me that there was a lazier way of doing this testing.  All I really needed to specify was the relative URL, parameters, headers, method, and expected response.  Someone else could do the signing and re-run the tests with the various options (such as specifying the MIME Type via the <tt>Accept:</tt> header, and then again via a file extension in the URL).</p>
<p>
I ended up creating a bunch of text files with this information.  I then used a Ruby script to generate two things:  an XML file that could be deserialized into a java object useful for testing, and a PHP script to test our PHP client API.
</p>
<p>
The Ruby script would also do things like calculate the signature (the test text files contained the api and secret keys a Gliffy user would have to use the API) and generate some derivative tests (e.g. one using a <tt>DELETE</tt>, and another tunneling that over <tt>POST</tt>).  The testing engine could generate some additional derivative tests (e.g. GET requests should respond to conditional gets if the server sent back an <tt>ETag</tt> or <tt>Last-Modified</tt> header).  All this then runs as a <a href="http://testng.org">TestNG</a> test.  
</p>
<p>
The whole thing works well, but is pretty hackish.  So, RestUNIT was created as a fresh codebase to create a more stable and useful testing engine.  My hope is to specify tests as YAML or some other human-readable markup, instead of XML (which is essentially binary for any real-sized data) and to allow for more sophisticated means of comparing results, deriving tests, and running outside a container (all the Gliffy tests require a specific data set and run in-container).
</p>
<p>
</p>
The test specification format should then be usable to generate tests in any other language (like I did with PHP).  I'm working on this slowly in my spare time and trying to keep the code clean and the architecture extensible, but not overly complex.
</p>

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2008/09/11/schema-for-rest-services.html">Schema for REST services</a></h1>
        
        <h2 class="f6 mtneg">September 11, 2008</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            <p>
I'm currently working the <a href="http://jira.gliffy.com/browse/GLIFFY-775">integration API</a> for <a href="//www.gliffy.com">Gliffy</a>, which is a REST-based service.  The API is fairly stable and we're readying a few ancillary things for release.  One of those is the documentation for the API.  I found it quite difficult to completely describe the REST services and ultimately  ended up creating something that lists out "objects" and "methods", even though the API is not really object-based.  For example, the object "Diagram" has a "method" called "list"; to "call" it, you do an HTTP <tt>GET</tt> to <tt>accounts/<i>your account name</i>/diagrams</tt>. 
</p>
<p>The original spec I created to work against (and thus, our initial draft of API documentation) was basically a list of URLs and the HTTP methods they responded to.  Not very easy to navigate or understand on a first sitting.  Some sort of schema to describe the REST API would have been really helpful (along the lines of an XML Schema).  Such a schema could facilitate documentation, testing, code generation.
</p>
<p>
As an example, consider some features of the Gliffy API: you can list the users in an account, list the diagrams in an account and reference an individual diagram via id.  Here's a YAML-esque description of these services:
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="s">&lt;b&gt;accounts:&lt;/b&gt;</span><span class="err"></span>
  <span class="s">&lt;b&gt;kind:&lt;/b&gt; literal</span><span class="err"></span>
  <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"Reference to all accounts"&lt;/i&gt;</span><span class="err"></span>
  <span class="s">&lt;b&gt;POST:&lt;/b&gt;</span><span class="err"></span>
    <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"Creates a new account"&lt;/i&gt;</span><span class="err"></span>
    <span class="s">&lt;b&gt;parameters:&lt;/b&gt;</span><span class="err"></span>
        <span class="s">- account_name</span><span class="err"></span>
            <span class="s">&lt;b&gt;required:&lt;/b&gt; true</span><span class="err"></span>
            <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"Name of the account you want to create"&lt;/i&gt;</span><span class="err"></span>
        <span class="s">- admin_email</span><span class="err"></span>
            <span class="s">&lt;b&gt;required:&lt;/b&gt; true</span><span class="err"></span>
            <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"Email address of an administrator for the new account"&lt;/i&gt;</span><span class="err"></span>
  <span class="s">&lt;b&gt;children:&lt;/b&gt;</span><span class="err"></span>
     <span class="s">&lt;b&gt;account_name:&lt;/b&gt;</span><span class="err"></span>
       <span class="s">&lt;b&gt;kind:&lt;/b&gt; variable</span><span class="err"></span>
       <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"The name of your account"&lt;/i&gt;</span><span class="err"></span>
       <span class="s">&lt;b&gt;GET:&lt;/b&gt;</span><span class="err"></span>
         <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"Returns meta-data about the account"&lt;/i&gt;</span><span class="err"></span>
         <span class="s">&lt;b&gt;parameters:&lt;/b&gt;</span><span class="err"></span>
            <span class="s">- show_users</span><span class="err"></span>
              <span class="s">&lt;b&gt;required:&lt;/b&gt; false</span><span class="err"></span>
              <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"If true, users are included, if false, they are not"&lt;/i&gt;</span><span class="err"></span>
       <span class="s">&lt;b&gt;children:&lt;/b&gt;</span><span class="err"></span>
         <span class="s">&lt;b&gt;diagrams:&lt;/b&gt;</span><span class="err"></span>
           <span class="s">&lt;b&gt;kind:&lt;/b&gt; literal</span><span class="err"></span>
           <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"All diagrams in the account"&lt;/i&gt;</span><span class="err"></span>
           <span class="s">&lt;b&gt;POST:&lt;/b&gt;</span><span class="err"></span>
             <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"Creates a new diagram"&lt;/i&gt;</span><span class="err"></span>
             <span class="s">&lt;b&gt;parameters:&lt;/b&gt;</span><span class="err"></span>
               <span class="s">- diagram_name</span><span class="err"></span>
                 <span class="s">&lt;b&gt;required:&lt;/b&gt; true</span><span class="err"></span>
                 <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"Desired name for this diagram"&lt;/i&gt;</span><span class="err"></span>
               <span class="s">- template_id</span><span class="err"></span>
                 <span class="s">&lt;b&gt;required:&lt;/b&gt; false</span><span class="err"></span>
                 <span class="s">&lt;b&gt;type:&lt;/b&gt; numeric</span><span class="err"></span>
                 <span class="s">&lt;b&gt;dsec:&lt;/b&gt; &lt;i&gt;"If present, the id of the diagram to copy, instead of using the blank one"&lt;/i&gt;</span><span class="err"></span>
           <span class="s">&lt;b&gt;GET:&lt;/b&gt;</span><span class="err"></span>
             <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"Gets a list of all diagrams in this account"&lt;/i&gt;</span><span class="err"></span>
           <span class="s">&lt;b&gt;children:&lt;/b&gt;</span><span class="err"></span>
             <span class="s">&lt;b&gt;id:&lt;/b&gt;</span><span class="err"></span>
               <span class="s">&lt;b&gt;kind:&lt;/b&gt; variable</span><span class="err"></span>
               <span class="s">&lt;b&gt;type:&lt;/b&gt; numeric</span><span class="err"></span>
               <span class="s">desc &lt;i&gt;"The id of a particular diagram"&lt;/i&gt;</span><span class="err"></span>
               <span class="s">&lt;b&gt;GET:&lt;/b&gt;</span><span class="err"></span>
                 <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"Gets the diagram; the requested encoding type will determine the form"&lt;/i&gt;</span><span class="err"></span>
                 <span class="s">&lt;b&gt;parameters:&lt;/b&gt;</span><span class="err"></span>
                   <span class="s">- &lt;b&gt;version:&lt;/b&gt; </span><span class="err"></span>
                     <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"The version to get, 1 is the original version.  If omitted, current version is retrieved"&lt;/i&gt;</span><span class="err"></span>
                     <span class="s">&lt;b&gt;required:&lt;/b&gt; false</span><span class="err"></span>
                     <span class="s">&lt;b&gt;type:&lt;/b&gt; numeric</span><span class="err"></span>
                   <span class="s">- &lt;b&gt;size:&lt;/b&gt;</span><span class="err"></span>
                     <span class="s">&lt;b&gt;desc:&lt;/b&gt; "For rastered formats, determins the size</span><span class="err"></span>
                     <span class="s">&lt;b&gt;type:&lt;/b&gt; enumeration</span><span class="err"></span>
                       <span class="s">- L</span><span class="err"></span>
                       <span class="s">- M</span><span class="err"></span>
                       <span class="s">- S</span><span class="err"></span>
               <span class="s">&lt;b&gt;DELETE:&lt;/b&gt;</span><span class="err"></span>
                 <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"Deletes this image"&lt;/i&gt;</span><span class="err"></span>
          <span class="s">&lt;b&gt;users:&lt;/b&gt;</span><span class="err"></span>
            <span class="s">&lt;b&gt;kind:&lt;/b&gt; literal</span><span class="err"></span>
            <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"All users in the account"&lt;/i&gt;</span><span class="err"></span>
            <span class="s">&lt;b&gt;GET:&lt;/b&gt;</span><span class="err"></span>
              <span class="s">&lt;b&gt;desc:&lt;/b&gt; &lt;i&gt;"gets a list of all users in the account"&lt;/i&gt;</span></code></pre></figure>
Since "accounts" is the only top-level element, we are saying that every request to this service must start with <tt>accounts/</tt>.  It has one child, which is a variable value for the account name.  It is untyped, so any potential string is allowed.  <b>That element</b> has two possible children: <tt>diagrams</tt> and <tt>users</tt>.  <tt>diagrams</tt> indicates that it responds to the HTTP methods <tt>POST</tt> and <tt>GET</tt>.  A <tt>POST</tt> requires the parameter <tt>diagram_name</tt>, while the parameter <tt>version</tt> is optional.
</p>
<p>
A standard format like this could easily be used to generate documentation, expectations, test cases,  and even stub code.   This format could even be delivered by an <tt>OPTIONS</tt> call to a resource.  I realize there is not much standardization around how to design and implement a REST service, but something like this could at least be a stake in the ground and support a specific method.
</p>

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2008/09/08/didnt-do-test-driven-design-record-your-test-cases-later.html">Didn't do Test-Driven Design?  Record your test cases later</a></h1>
        
        <h2 class="f6 mtneg">September 08, 2008</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            <p><i>Following on from <a href="http://www.gliffy.com/blog/2008/09/09/testing-gliffy-without-testers/">my post on Gliffy's blog...</a></i></p>
<p>
On more than a few occasions, I've been faced with making significant refactorings to an existing application.   These are things where we need to overhaul an architectural component without breaking anything, or changing the application's features.  For an applicaiton without any test cases, this is not only scary, but ill-advised.  </p>
<p>
I believe this is the primary reason that development shops hang on to out-dated technology.  I got a job at a web development shop after <b>four</b> years of doing nothing but Swing and J2EE.  My last experience with Java web development was Servlets, JSPs and taglibs.  This company was <b>still</b> using these as the primary components of their architecture.  No Struts, no Spring, no SEAM.  Why?  One reason was that they had <b>no</b> test infrastructure and therefore <b>not</b> ability to refactor anything.
</p>
<h3>Doing it anyway</h3>
<p>
Nevertheless, sometimes the benefits outweigh the costs and you <b>really</b> need to make a change.  At <a href="http://www.gliffy.com">Gliffy</a>, I was hired to create an API to integrate editing Gliffy diagrams into the workflow of other applications.  After a review of their code and architecture, the principals and I decided that the database layer needed an overhaul.  It was using JDBC/SQL and had become difficult to change (especially to the new guy: me).  I suggested moving to the  <a href="http://www.naildrivin5.com/daveblog5000/?tag=jpa">Java Persistence Architecture</a> (backed by Hibernate), and they agreed.  Only problem was how to make sure I didn't break anything.  They didn't have automated tests, and I was totally new to the application environment.
</p>
<p>
They <b>did</b> have test scripts for testers to follow that would hit various parts of the application.  Coming from my previous enviornment, that in and of itself was amazing.  Since the application communicates with the server entirely via <tt>HTTP POST</tt>, and recieves mostly XML back, I figured I could manually execute the tests and record them in a way so they could be played back later as regression tests. 
</p>
<h3>Recording Tests</h3>
<p>
This is suprisingly easy thanks to the filtering features of the Servlet specification:
<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">&lt;</span><span class="n">filter</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">filter</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="n">recorder</span><span class="o">&lt;/</span><span class="n">filter</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">filter</span><span class="o">-</span><span class="kd">class</span><span class="err">&gt;</span><span class="nc">com</span><span class="o">.</span><span class="na">gliffy</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">online</span><span class="o">.</span><span class="na">RecordServletFilter</span><span class="o">&lt;/</span><span class="n">filter</span><span class="o">-</span><span class="kd">class</span><span class="err">&gt;</span>
<span class="err">&lt;/</span><span class="nc">filter</span><span class="o">&gt;</span>

<span class="o">&lt;!--</span> <span class="o">...</span> <span class="o">--&gt;</span>

<span class="o">&lt;</span><span class="n">filter</span><span class="o">-</span><span class="n">mapping</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">filter</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="n">recorder</span><span class="o">&lt;/</span><span class="n">filter</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">url</span><span class="o">-</span><span class="n">pattern</span><span class="o">&gt;/*&lt;/</span><span class="n">url</span><span class="o">-</span><span class="n">pattern</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">filter</span><span class="o">-</span><span class="n">mapping</span><span class="o">&gt;</span></code></pre></figure>

The filter code is bit more complex, because I had to create proxy classes for <tt>HttpServletRequest</tt> and <tt>HttpServletResponse</tt>.  Here's an overview of how everything fits together:
<a href="http://www.gliffy.com/pubdoc/1487626/L.jpg"><img src="http://www.gliffy.com/pubdoc/1487626/S.jpg" border=0></a>
</p>
<p>The request proxy had to read everything from the requests input stream, save it, and send a new stream that would output the same data to the caller.  It had to do the same thing with the <tt>Reader</tt>.  I'm sure it's an error to use both in the same request, and Gliffy's code didn't do that, so this worked well.
<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">RecordingServletRequest</span> <span class="kd">extends</span> <span class="n">javax</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpServletRequestWrapper</span>
<span class="o">{</span>
    <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">ServletInputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="n">String</span> <span class="n">readerContent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">byte</span> <span class="n">inputStreamContent</span><span class="o">[]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">RecordingServletRequest</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">r</span><span class="o">);</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="n">BufferedReader</span> <span class="n">getReader</span><span class="o">()</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">reader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="n">StringWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">();</span>
            <span class="n">BufferedReader</span> <span class="n">superReader</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">getReader</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">superReader</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">superReader</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">readerContent</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">readerContent</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">reader</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">ServletInputStream</span> <span class="n">getInputStream</span><span class="o">()</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">inputStream</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="n">ByteArrayOutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
            <span class="n">ServletInputStream</span> <span class="n">superInputStream</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">superInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">b</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">superInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">inputStreamContent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
            <span class="n">inputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayServletInputStream</span><span class="o">(</span><span class="n">inputStreamContent</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">inputStream</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>
</p>
<p>
The response recorder was a bit trickier,  because I needed to save things like status codes and content types.  This implementation probably wouldn't work for all clients (for example, it ignores any response headers), but since Gliffy is an OpenLaszlo app, and OpenLaszlo has almost <b>no</b> view into HTTP, this worked well for our purposes.  Again, I had to wrap the <tt>OutputStream</tt>/<tt>Writer</tt> so I could record what was being sent back.
<figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">RecordingServletResponse</span> <span class="kd">extends</span> <span class="n">HttpServletResponseWrapper</span>
<span class="o">{</span>
    <span class="kd">public</span> <span class="n">RecordingServletResponse</span><span class="o">(</span><span class="n">HttpServletResponse</span> <span class="n">r</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="n">statusCode</span><span class="o">;</span>
    <span class="n">StringWriter</span> <span class="n">stringWriter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">ByteArrayOutputStream</span> <span class="n">byteOutputStream</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">contentType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">PrintWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">ServletOutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">ServletOutputStream</span> <span class="n">getOutputStream</span><span class="o">()</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">outputStream</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="n">byteOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
            <span class="n">outputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecordingServletOutputStream</span><span class="o">(</span><span class="kd">super</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">(),</span><span class="k">new</span> <span class="n">PrintStream</span><span class="o">(</span><span class="n">byteOutputStream</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">outputStream</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">PrintWriter</span> <span class="n">getWriter</span><span class="o">()</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="n">stringWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">();</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecordingPrintWriter</span><span class="o">(</span><span class="kd">super</span><span class="o">.</span><span class="na">getWriter</span><span class="o">(),</span><span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="n">stringWriter</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">writer</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="n">sendError</span><span class="o">(</span><span class="kt">int</span> <span class="n">sc</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">statusCode</span> <span class="o">=</span> <span class="n">sc</span><span class="o">;</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="n">sendError</span><span class="o">(</span><span class="kt">int</span> <span class="n">sc</span><span class="o">,</span> <span class="n">String</span> <span class="n">msg</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">statusCode</span> <span class="o">=</span> <span class="n">sc</span><span class="o">;</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">sc</span><span class="o">,</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setStatus</span><span class="o">(</span><span class="kt">int</span> <span class="n">sc</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">statusCode</span> <span class="o">=</span> <span class="n">sc</span><span class="o">;</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setContentType</span><span class="o">(</span><span class="n">String</span> <span class="n">type</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">contentType</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>
</p>
<p>
The filter then needs to use this and inject them into the actual servlet calls:
<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="p">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span>
<span class="o">{</span>
    <span class="n">RecordingServletRequest</span> <span class="n">recordingRequest</span> <span class="o">=</span> 
      <span class="k">new</span> <span class="n">RecordingServletRequest</span><span class="o">((</span><span class="n">HttpServletRequest</span><span class="o">)</span><span class="n">request</span><span class="o">);</span>
    <span class="n">RecordingServletResponse</span> <span class="n">recordingResponse</span> <span class="o">=</span> 
      <span class="k">new</span> <span class="n">RecordingServletResponse</span><span class="o">((</span><span class="n">HttpServletResponse</span><span class="o">)</span><span class="n">response</span><span class="o">);</span>

    <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">recordingRequest</span><span class="o">,</span><span class="n">recordingResponse</span><span class="o">);</span>
    </code></pre></figure>
After the call to <tt>doFilter</tt>, we can then examine the proxy request/respons and record the test.  I'll spare you 20 lines of <tt>setXXX</tt> methods.  I created a Java bean class and used XStream to serialize it.  I then created another class that runs as a TestNG test to deserialize these files and make the same requests.  I record the response and see if it matches.
</p>
<h3>Running the Tests</h3>
<p>
There were a few problems with this approach:
<ul>
<li>The tests required certain test data to exist</li>
<li>Each test potentially modifies the database, meaning the tests have to be run in the order they were created.</li>
<li>The test results had temporal data in them that, while irrelevant to the tests "passing", complicated exact-match comparisions of results</li>
</ul>
TestNG (and JUnit) are not really designed for this; they are more for proper <i>unit</i> testing, where each test can be run indepedent of the others and the results compared.  While there are facilities for setting up test data and cleaning up, the idea of resetting the database before each of the 300 tests I would record was not appealing.  Faking/mocking the database was not an option; I was creating these tests specifically to make sure my changes to the database layer were not causing regressions.  I needed to test against a real database.
</p>
<p>
I ultimately decided to group my tests into logical areas, and ensure that: a) tests were run in a predictable order, and b) the first test of a group was run against a known dataset.  I created a small, but useful, test dataset and created a TestNG test that would do both (a) and (b).  It wasn't pretty, but it worked.  This clearly isn't the way a unit test framework should be used, and  I would call these sorts of tests <i>functional</i>, rather than <i>unit</i>.  But, since our CI system requires JUnit test results as output, and the JUnit format isn't documented, might as well use TestNG to handle it for me.
</p>
<p>
The last problem was making accurate comparisons of results.  I <b>did not</b> want to have to parse the XML returned by the server.  I settled on some regular expressions that stripped out temporal and transient data not relevant to the test.   Both the expected and received content were run through this regexp filter and <b>those</b> results were compared.  Parsing the XML might result in better failure messages (right now I have to do a visual diff, which is a pain), but I wasn't convinced that the existing XML diff tools were that useful.
</p>
<h3>Results</h3>
<p>
Overall, it worked out great.  I was able to completely overhaul the database layer, and the Gliffy client was none the wiser.  We were even able to use these tests to remove our dependence on Struts, simplifying the application's deployment (we weren't using many features of Struts anyway).  The final validation of these tests actually came recently, when we realized a join table needed to be exposed to our server-side code.  This was a major change in two key data container, and the recorded tests were crucial to finding bugs this introduced.
</p>
<p>
So, if you don't have the luxury of automated tests, you can always create them.  I did a similar thing with EJB3 using the <tt>Interceptors</tt> concept.
</p>

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2008/06/01/daily-backups-are-gonna-save-my-butt.html">Daily backups are gonna save my butt</a></h1>
        
        <h2 class="f6 mtneg">June 01, 2008</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            I used to never back up.  Well, I'd throw some iTunes songs on a DVD every once in a while, but that's about it.  Then, I started doing some pro audio work for friend's bands and figured it was time to get serious.  My home computer, though, never really got the treatment.  When I upgraded to Leopard, I reformatted an external drive for Time Machine, but I wanted to have something better, as a double-check on Time Machine.  So, I did what I do for pro audio, which is to get a Firewire drive the exact size of my main drive, and use <a href="http://www.shirt-pocket.com/SuperDuper/SuperDuperDescription.html">Super Duper!</a> to mirror the drive every night, leaving the resulting drive bootable.  A plain <tt>rsync</tt> won't work, for some reason; the drive gets duped, but isn't bootable.

So, last night, I made the mistake of putting an old CD-R with a sticker on it into my slot-loading iMac (my main computer).  Now, Apple needs to <b>abandon this god-forsaken idiotic design decision</b> that is literally designed to play <b>Russian roulette</b> every time you stick a disc in.  The one thing I will give Windows over Mac: when you put a disc in a Windows box, you have a 100% chance of getting back out (and a 99% chance that doing will result in a bootable computer).  Well, this disc wouldn't mount and wouldn't eject.  A reboot of my computer resulted in...nothing.  Gray screen forever.  FUCK YOU APPLE.  Would it really have been so bad to have a button?  A tray that sticks out?  Ugh.  So, now I have to take my iMac to the Apple store to <b>pray to Jobs</b> that they can get the CD out.  Meanwhile, I've got work to do.

So, I grab my Macbook Pro that I use for Pro Audio, plug in my trusty firewire mirror drive, boot and...viola!  It's like I never left?  Thankfully, the only thing I've done on my computer today was check email and surf the web and since those things are, you know, still on the Internet, I'm back.  I don't know how I'm going to sync things back up when I get my box back, but I am thanking GOD right now that I do nightly backups (and that I have another computer to fall back on).  I guess when working from home, it's good to have a spare.

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2008/05/14/using-threadlocal-and-servlet-filters-to-cleanly-access-jpa-an-entitymanager.html">Using ThreadLocal and Servlet Filters to cleanly access JPA an EntityManager</a></h1>
        
        <h2 class="f6 mtneg">May 14, 2008</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            My current project is slowly moving from JDBC-based database interaction to JPA-based.  Following good sense, I'm trying to change things as little as possible.  One of those things is that we are deploying under Tomcat and not under a full-blown J2EE container.  This means that EJB3 is out.  After my <a href="http://www.naildrivin5.com/daveblog5000/?p=37">post regarding this configuration</a>, I quickly realized that my code started to get littered with:

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">try</span>
<span class="o">{</span>
  <span class="n">em</span> <span class="o">=</span> <span class="n">EntityManagerUtil</span><span class="o">.</span><span class="na">getEntityManager</span><span class="o">();</span>
  <span class="c1">// do stuff with entity manager</span>
<span class="o">}</span>
<span class="k">finally</span>
<span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">em</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">em</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"While closing an EntityManager"</span><span class="o">,</span><span class="n">t</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

Pretty ugly, and seriously annoying to have to add <b>13 lines of code</b> to any method that needs to interact with the database.  The Hibernate docs suggest using <tt>ThreadLocal</tt> variables to provide access to the EntityManager throughout the life of a request (which wouldn't really work for a Swing app, but since this is servlet-based, it should work fine).    The <tt>ThreadLocal</tt> javadocs contain possibly the most annoying example ever, and I didn't follow how to use it.

Anyway, I finally got around to it, and also solved the close problem as well, by using a Servlet Filter.  I guess this type of thing would normally be solvable by Spring or Guice, but I didn't want to drag all of that into the application to refactor this one thing; I would've easily spent the rest of the day dealing with XML confihuration and deployment.

The solution was quite simple:

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/** Provides access to the entity manager.  */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EntityManagerUtil</span> 
<span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ThreadLocal</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">EntityManager</span><span class="o">&gt;</span> 
        <span class="n">ENTITY_MANAGERS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">EntityManager</span><span class="o">&gt;();</span>

    <span class="cm">/** Returns a fresh EntityManager */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">EntityManager</span> <span class="n">getEntityManager</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">ENTITY_MANAGERS</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EntityManagerFilter</span> <span class="kd">implements</span> <span class="n">Filter</span>
<span class="o">{</span>
    <span class="kd">private</span> <span class="n">Logger</span> <span class="n">itsLogger</span> <span class="o">=</span> <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">EntityManagerFactory</span> <span class="n">theEntityManagerFactory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="n">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span>
    <span class="o">{</span>
        <span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span>
        <span class="o">{</span>
            <span class="n">em</span> <span class="o">=</span> <span class="n">theEntityManagerFactory</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
            <span class="n">EntityManagerUtil</span><span class="o">.</span><span class="na">ENTITY_MANAGERS</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">em</span><span class="o">);</span>
            <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span><span class="n">response</span><span class="o">);</span>
            <span class="n">EntityManagerUtil</span><span class="o">.</span><span class="na">ENTITY_MANAGERS</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">finally</span>
        <span class="o">{</span>
            <span class="k">try</span> 
            <span class="o">{</span> 
                <span class="k">if</span> <span class="o">(</span><span class="n">em</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> 
                    <span class="n">em</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> 
            <span class="o">}</span>
            <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span> 
                <span class="n">itsLogger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"While closing an EntityManager"</span><span class="o">,</span><span class="n">t</span><span class="o">);</span> 
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">init</span><span class="o">(</span><span class="n">FilterConfig</span> <span class="n">config</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">destroy</span><span class="o">();</span>
        <span class="n">theEntityManagerFactory</span> <span class="o">=</span> 
          <span class="n">Persistence</span><span class="o">.</span><span class="na">createEntityManagerFactory</span><span class="o">(</span><span class="s">"gliffy"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">destroy</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">theEntityManagerFactory</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">theEntityManagerFactory</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

So, when the web app gets deployed, the entity manager factory is created (and closed when the web app is removed).  Each thread that calls <tt>EntityManagerUtil</tt> to get an EntityManager gets a fresh one that persists for the duration of the request.  When the request is completed, the entity manager is closed automatically.

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2008/05/09/time-machine-almost-saved-me-but-git-won-out-in-the-end.html">Time Machine almost saved me, but git won out in the end</a></h1>
        
        <h2 class="f6 mtneg">May 09, 2008</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            So, I'm working on a project that's using Subversion for version control.  My network connection isn't great, plus subversion is slow, plus git is (so far) pretty awesomely awesome. The way to interact with an SVN repository is via <tt>git-svn</tt>, <a href="http://www.naildrivin5.com/daveblog5000/?p=36">that I talked about setting up previously</a>.  Everything's been going great, however I don't frequently commit to subversion.  This week, we started setting up continuous integration for my work, so I did an <tt>git-svn dcommit</tt>, committing two days worth of changes.  I had forgotten that I had made so many changes (including adding <a href="http://www.naildrivin5.com/daveblog5000/?p=37">hibernate support</a>).  I misread the commit messages and thought something bad was happening.  Control-C.  <tt>git log</tt>.  HEAD is recent.  Last commit was....yesterday.  Oh. Fuck.

I figure <tt>git-svn</tt> borked something, so I <tt>git-rest --hard</tt>.  No effect.  I'm starting to panic, now.  almost 2 days of work lost is not something I'm looking forward to.  I hasitly go into Time Machine and get the previous hours' backup.  But, I just <b>hate</b> that solution.  I have no idea what happened, and my trust in Git (or my ability to use it) has to be restored.  After IM'ing with a co-worker, I got to the bottom of it.

It turns out that I wasn't paying attention to how <tt>git-svn</tt> works.  What it does when you do a <tt>rebase</tt> or <tt>dcommit</tt> (which implicitly does a <tt>rebase</tt>), is to first undo all your changes since your last <tt>rebase</tt>/<tt>dcommit</tt>, and get the changes made to the SVN repository (it even says as much as the first line of the output).  It then "replays" your commits to make sure there's no conflicts.

By hitting Control-C in the middle of that, I manually caused the same situation that would happen if there were conflicts.  Git stops, tells you to resolve conflicts, and asks you to <tt>git-rebase --continue</tt>.  If I had just <tt>git-rebase --continue</tt>'ed, I would be fine. Since I did a hard rest, I figured I was fucked.  Enter the log.

<tt>.git/logs/HEAD</tt> contained information about all activity, including my missing commits.  I grab the version numbers (which, in Git, are hashes of the entire repository), do a <tt>git-reset --hard big.honkin.git.hash.version</tt> and <b>viola!</b> everything's back to how it was (the command ran instanteously, to boot).


          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2008/05/08/using-java-persistence-with-tomcat-and-no-ejbs.html">Using Java Persistence with Tomcat and no EJBs</a></h1>
        
        <h2 class="f6 mtneg">May 08, 2008</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            The project I'm working on is deployed under Tomcat and isn't using EJBs.  The codebase is using JDBC for database access and I'm looking into using some O/R mapping.  Hibernate is great, but Java Persistence is more desirable, as it's more of a standard.  Getting it to work with EJB3 is dead simple.  Getting it to work without EJB was a bit more problematic.

The entire application is being deployed as a WAR file.  As such, the JPA configuration artifacts weren't getting picked up.  Setting aside how absolutely horrendous Java Enterprise configuration is, here's what ended up working for me:

<ul>
<li>Create a <tt>persistence.xml</tt> file as per standard documentation <b>leaving out the <tt>jta-data-source</tt> stanza</b> (I could not figure out how to get Hibernate/JPA to find my configured data source)</li>
<li>Create your <tt>hibernate.cfg.xml</tt>, being sure to <b>include JDBC conncetion info</b>.  This will result in hibernate managing connections for you, which is fine</li>
<li>Create a persistence jar containing:
    <ul>
    <li>Hibernate config at root</li>
    <li><tt>persistence.xml</tt> in <tt>META-INF</tt></li>
    <li>All classes with JPA annotations in root (obviously in their java package/directory structure)</li>
    </ul></li>
<li>This goes into <tt>WEB-INF/lib</tt> of the war file (being careful to omit the JPA-annotated classes from <tt>WEB-INF/classes</tt></li>
</ul>

The first two steps took a while to get to and aren't super clear from the documentation.

To use JPA, this (non-production quality) code works:

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">EntityManagerFactory</span> <span class="n">emf</span> <span class="o">=</span> 
    <span class="n">Persistence</span><span class="o">.</span><span class="na">createEntityManagerFactory</span><span class="o">(</span><span class="s">"name used in persistence.xml"</span><span class="o">);</span>
<span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">emf</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span> 

<span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from Account where name = :name"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">itsAccountName</span><span class="o">);</span>
<span class="n">List</span> <span class="n">results</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>

<span class="c1">// do stuff with your results</span>

<span class="n">em</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="n">emf</span><span class="o">.</span><span class="na">close</span><span class="o">();</span></code></pre></figure>

The <tt>EntityManagerFactory</tt> is supposed to survive the life of application and not be created/destroyed on every request.

I also believe there might be some transaction issues with this, but I can't figure out from the documentation what they are and if they are a big deal for a single-database application.

<b>Update</b>:  Turns out, it's not quite this simple.  Since this configuration is running outside an EJB container, and given <a href="http://opensource.atlassian.com/projects/hibernate/browse/HHH-2382">Bug $2382</a>, you can query all day long, but you cannot persist.  To solve this, you must work in a transaction, as so:

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">EntityManagerFactory</span> <span class="n">emf</span> <span class="o">=</span> 
    <span class="n">Persistence</span><span class="o">.</span><span class="na">createEntityManagerFactory</span><span class="o">(</span><span class="s">"name used in persistence.xml"</span><span class="o">);</span>
<span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">emf</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span> 
<span class="n">EntityTransaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">();</span>

<span class="n">tx</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
<span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from Account where name = :name"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">itsAccountName</span><span class="o">);</span>
<span class="n">List</span> <span class="n">results</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>

<span class="c1">// modify your results somehow via persist() </span>
<span class="c1">// or merge()</span>

<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="n">em</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="n">emf</span><span class="o">.</span><span class="na">close</span><span class="o">();</span></code></pre></figure>

Again, this is <b> not production code</b> as <b>no</b> error handling has been done at all, but you get the point.

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2008/04/28/git-and-svn-connecting-git-branches-to-svn-branches.html">Git and SVN: connecting git branches to svn branches</a></h1>
        
        <h2 class="f6 mtneg">April 28, 2008</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            Currently working on a project where Subversion is the CM system of choice.  I'd like to use git, as it's faster and doesn't require so much network access.  Plus, I'm hoping when it comes time to merge, I can simplify the entire process by using git's allegedly superior merging technique.  At any rate, I've got a branch on SVN to work on, and I want to track both that branch and the entire svn tree.

Saturday morning, I did a <tt>git-svn init</tt> from their repository.  Today, after lunch, it finished.  After doing a <tt>git-gc</tt> to clean up the checkout, it wasn't clear how to connect branches.  Following is what I did (assume my subversion branch is <tt>branches/FOO</tt>):

<blockquote><pre>
git-checkout -b local-trunk trunk
git branch local-foo FOO
</pre></blockquote>

The first thing creates a new branch called "local-trunk" started at "trunk" (which is the remote branch mapping to the subversion main trunk).  The second command creates a new branch called "local-foo", which is rooted at remote branch "FOO".  I have no clue why I couldn't do the same thing twice, as both commands seem to do the same thing (the first switches to the branch "local-trunk" after creating it).  But, this is what worked for me.

Now, to develop, I <tt>git checkout local-foo</tt> and commit all day long.  a <tt>git-svn dcommit</tt> will send my changes to subversion on the FOO branch.  I can update the trunk via <tt>git checkout local-trunk</tt> and <tt>git-svn rebase</tt>.  My hope is that I can merge from the trunk to my branch periodically and then, when my code is merged to the trunk, things will be pretty much done and ready to go.  We'll see.

On a side note, the git repository, which contains <b>every revision of every file in the subversion repository</b> is 586,696 bytes.  The subversion checkout of <b>just the FOO branch</b> is 1,242,636 bytes; over double the size, and there's still not enough info in that checkout to do a log or diff between versions.

          </section>
        
      
    </article>
  
  <footer class="center border-top">
    <nav class="pt2 pb2">
      
        <a class="fw-bold prev pr2" href="/page18">&larr; Older</a>
      
      <a class="" href="/blog/archives">All Posts</a>
      
        <a class="fw-bold next pl2" href="/page16">Newer &rarr;</a>
      
    </nav>
  </footer>
</div>

    </section>
  </main>
  <footer class="center">
    <p class="f6">
      Copyright &copy; 2006-2016, by David Bryant Copeland, All Rights Reserved
    </p>
  </footer>
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '56a22cd9c88d90284f000861');
      t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
      t.src = 'https://d36ee2fcip1434.cloudfront.net/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>
</body></html>
